# Maintainer: William Turner <willtur dot will at gmail dot com>

pkgname=wine-wow64-ntsync-minimal
pkgver=9.2
_pkgver="${pkgver/rc/-rc}"
_ntsync_patch='b1d7ee352c4f4e1dcbc1cbf738975e51b87d6113'
pkgrel=1
pkgdesc='A compatibility layer for running Windows programs (minimal Wow64 with NTSync)'
arch=('x86_64')
url='https://www.winehq.org'
license=('LGPL')
depends=('libunwind'
         'libx11'
         'libxext')
makedepends=('mingw-w64-gcc'
             'ntsync-header')
provides=("wine=${pkgver}")
conflicts=('wine')
options=(!lto)
source=("https://dl.winehq.org/wine/source/${pkgver::1}.x/wine-${_pkgver}.tar.xz"
        "https://raw.githubusercontent.com/Frogging-Family/wine-tkg-git/${_ntsync_patch}/wine-tkg-git/wine-tkg-patches/misc/fastsync/ntsync5.patch")
sha256sums=('8281c5a082cc47ac3c2c91ceaade5f17396553b39adcb32e741253865b658162'
            'c0c846aa4a69032dac2184024efbb3f9a0ab555e11c2d64aa20be4d612ad2ffe')

prepare() {
  cd "wine-${_pkgver}"

  patch -p1 -i "${srcdir}/ntsync5.patch"
}

build() {
  cd "wine-${_pkgver}"

  ./configure \
    --prefix=/usr \
    --libdir=/usr/lib \
    \
    --disable-tests \
    --disable-win16 \
    --enable-archs=x86_64,i386 \
    --enable-win64 \
    \
    --with-gnutls \
    --with-opengl \
    --with-pthread \
    --with-unwind \
    --with-x \
    --with-xcomposite \
    --with-xinput2 \
    --with-xrender \
    --with-xshape \
    --with-xshm \
    --without-alsa \
    --without-capi \
    --without-coreaudio \
    --without-cups \
    --without-dbus \
    --without-fontconfig \
    --without-freetype \
    --without-gettext \
    --without-gettextpo \
    --without-gphoto \
    --without-gssapi \
    --without-gstreamer \
    --without-inotify \
    --without-krb5 \
    --without-mingw \
    --without-netapi \
    --without-opencl \
    --without-osmesa \
    --without-oss \
    --without-pcap \
    --without-pcsclite \
    --without-pulse \
    --without-sane \
    --without-sdl \
    --without-udev \
    --without-usb \
    --without-v4l2 \
    --without-vulkan \
    --without-wayland \
    --without-xcursor \
    --without-xfixes \
    --without-xinerama \
    --without-xinput \
    --without-xrandr \
    --without-xxf86vm

  make
}

package() {
  cd "wine-${_pkgver}"

  make \
    prefix="${pkgdir}/usr" \
    libdir="${pkgdir}/usr/lib" \
    dlldir="${pkgdir}/usr/lib/wine" \
    install

  i686-w64-mingw32-strip --strip-unneeded "${pkgdir}/usr/lib/wine/i386-windows/"*.dll
  x86_64-w64-mingw32-strip --strip-unneeded "${pkgdir}/usr/lib/wine/x86_64-windows/"*.dll

  ln -sf wine "${pkgdir}/usr/bin/wine64"
}
